<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Arena â€“ Redesigned</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --primary: #6a5af9; --secondary: #5041d5; --accent: #f72585;
    --bg-light: #f4f7fc; --bg-dark: #161925;
    --surface-light: #ffffff; --surface-dark: #232a40;
    --text-light: #212529; --text-dark: #e8eaed;
    --border-light: rgba(0, 0, 0, 0.1); --border-dark: rgba(255, 255, 255, 0.1);
    --glass-light: rgba(255, 255, 255, 0.7); --glass-dark: rgba(35, 42, 64, 0.7);
    --success: #20c997; --danger: #e63946; --warning: #ffb703; --info: #0096c7;
  }

  * { box-sizing: border-box; }

  body {
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-light);
    color: var(--text-light);
    margin: 0;
    transition: background-color 0.3s, color 0.3s;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  body.dark-mode {
    background-color: var(--bg-dark);
    color: var(--text-dark);
  }

  /* --- Main Layout --- */
  .quiz-layout {
    display: grid;
    grid-template-columns: 260px 1fr 280px;
    height: 100vh;
    overflow: hidden;
  }

  .quiz-sidebar, .quiz-main, .quiz-palette {
    height: 100vh;
    overflow-y: auto;
    padding: 20px;
  }

  .quiz-sidebar {
    background-color: var(--surface-light);
    border-right: 1px solid var(--border-light);
  }
  body.dark-mode .quiz-sidebar {
    background-color: var(--surface-dark);
    border-right-color: var(--border-dark);
  }

  .quiz-palette {
    background-color: var(--surface-light);
    border-left: 1px solid var(--border-light);
  }
  body.dark-mode .quiz-palette {
    background-color: var(--surface-dark);
    border-left-color: var(--border-dark);
  }

  /* --- Shared Card Style --- */
  .card-ui {
    background-color: var(--surface-light);
    border-radius: 12px;
    border: 1px solid var(--border-light);
    margin-bottom: 20px;
    padding: 18px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
  }
  body.dark-mode .card-ui {
    background-color: var(--surface-dark);
    border-color: var(--border-dark);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  /* --- Left Sidebar: Timer & Info --- */
  .quiz-brand { font-size: 24px; font-weight: 700; color: var(--primary); }
  .timer-box { text-align: center; }
  .timer-display { font-size: 48px; font-weight: 700; letter-spacing: 2px; }
  #timeProgress { height: 6px; border-radius: 3px; }

  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .stat-item { text-align: center; background: rgba(0,0,0,0.03); padding: 8px; border-radius: 8px; }
  body.dark-mode .stat-item { background: rgba(255,255,255,0.05); }
  .stat-item .value { font-weight: 700; font-size: 20px; }
  .stat-item .label { font-size: 12px; opacity: 0.7; }
  .value.correct { color: var(--success); }
  .value.incorrect { color: var(--danger); }
  .value.marked { color: var(--info); }
  .value.unattempted { color: var(--warning); }


  /* --- Main Content Area --- */
  .quiz-main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .mobile-menu-toggle { display: none; background: none; border: none; font-size: 22px; color: var(--text-light); }
  body.dark-mode .mobile-menu-toggle { color: var(--text-dark); }
  
  .q-text { font-size: 20px; font-weight: 500; margin: 12px 0; line-height: 1.6; }

  .option-btn {
    width: 100%; text-align: left;
    border: 1px solid var(--border-light);
    background: transparent; color: inherit;
    border-radius: 10px; padding: 14px 18px;
    margin: 8px 0; transition: .2s ease all; font-size: 16px;
  }
  body.dark-mode .option-btn { border-color: var(--border-dark); }
  .option-btn:hover { border-color: var(--primary); background: rgba(106,90,249, 0.05); transform: translateY(-2px); }
  .option-btn.selected { background: var(--secondary); color: #fff; border-color: var(--secondary); }
  .option-btn.correct { background: var(--success) !important; color: #fff; border-color: var(--success) !important; }
  .option-btn.incorrect { background: var(--danger) !important; color: #fff; border-color: var(--danger) !important; }

  .explanation {
    background: rgba(106,90,249, 0.05);
    border-left: 4px solid var(--primary);
    border-radius: 8px; padding: 14px; margin-top: 16px;
  }

  .quiz-nav-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
  .btn-nav { padding: 10px 20px; border-radius: 8px; font-weight: 600; }

  /* --- Right Sidebar: Question Palette --- */
  .palette-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 8px; }
  .q-tile {
    width: 100%; aspect-ratio: 1 / 1;
    display: flex; align-items: center; justify-content: center;
    border: 1px solid var(--border-light);
    border-radius: 8px; font-weight: 600; cursor: pointer;
    transition: .2s ease all;
  }
  body.dark-mode .q-tile { border-color: var(--border-dark); }
  .q-tile:hover { transform: scale(1.08); }
  .q-tile.current { background-color: var(--primary); color: #fff; border-color: var(--primary); }
  .q-tile.answered { background-color: var(--success); color: #fff; border-color: var(--success); }
  .q-tile.marked { box-shadow: 0 0 0 2px var(--info) inset; }
  .q-tile.review-correct { background-color: var(--success); color: #fff; border-color: transparent; }
  .q-tile.review-incorrect { background-color: var(--danger); color: #fff; border-color: transparent; }
  .q-tile.review-unattempted { background-color: var(--warning); color: #fff; border-color: transparent; }

  /* --- Results View --- */
  .results-container { text-align: center; }
  .final-score { font-size: 5rem; font-weight: 800; color: var(--primary); }
  .results-tabs .nav-link { color: inherit; opacity: 0.7; }
  .results-tabs .nav-link.active { color: var(--primary); font-weight: 600; opacity: 1; border-bottom: 2px solid var(--primary); border-radius: 0; background: none; }
  .chart-container { height: 250px; }

  /* --- Theme Toggle --- */
  .theme-toggle {
    position: fixed; right: 20px; bottom: 20px; width: 50px; height: 50px; border-radius: 50%;
    background: var(--surface-light); border: 1px solid var(--border-light); color: var(--text-light);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1); z-index: 1200; font-size: 20px;
  }
  body.dark-mode .theme-toggle { background: var(--surface-dark); border-color: var(--border-dark); color: var(--text-dark); }

  /* --- Responsive Design --- */
  @media (max-width: 992px) {
    .quiz-layout { grid-template-columns: 1fr; }
    .quiz-sidebar, .quiz-palette {
      position: fixed; top: 0;
      width: 280px; height: 100%;
      z-index: 1100;
      transition: transform 0.3s ease;
      box-shadow: 0 0 40px rgba(0,0,0,0.2);
    }
    .quiz-sidebar { transform: translateX(-100%); left: 0; border-right: none; }
    .quiz-palette { transform: translateX(100%); right: 0; border-left: none; }
    .quiz-sidebar.show, .quiz-palette.show { transform: translateX(0); }

    .mobile-menu-toggle { display: block; }
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 1090; opacity: 0; visibility: hidden; transition: .3s;
    }
    .overlay.show { opacity: 1; visibility: visible; }
  }
</style>
</head>
<body>

<audio id="clickSound" src="https://assets.mixkit.co/active_storage/sfx/269/269.wav" preload="auto"></audio>
<audio id="swipeSound" src="https://assets.mixkit.co/active_storage/sfx/1897/1897.wav" preload="auto"></audio>
<audio id="correctSound" src="https://assets.mixkit.co/active_storage/sfx/2870/2870.wav" preload="auto"></audio>
<audio id="wrongSound" src="https://assets.mixkit.co/active_storage/sfx/2964/2964.wav" preload="auto"></audio>

<div class="overlay" id="overlay"></div>

<div class="quiz-layout">

  <aside class="quiz-sidebar" id="infoSidebar">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="quiz-brand">Quiz Arena</div>
        <button class="mobile-menu-toggle" id="closeInfoSidebar"><i class="fas fa-times"></i></button>
    </div>
    <div class="card-ui timer-box">
        <div class="timer-display"><span id="minutes">00</span>:<span id="seconds">00</span></div>
        <div class="progress mt-2">
          <div id="timeProgress" class="progress-bar bg-primary" style="width:100%"></div>
        </div>
    </div>
    <div class="card-ui">
        <h5 class="fw-bold mb-3">Quiz Stats</h5>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="value correct" id="statAnswered">0</div>
                <div class="label">Answered</div>
            </div>
            <div class="stat-item">
                <div class="value unattempted" id="statUnanswered">0</div>
                <div class="label">Unanswered</div>
            </div>
            <div class="stat-item">
                <div class="value marked" id="statMarked">0</div>
                <div class="label">Marked</div>
            </div>
             <div class="stat-item">
                <div class="value" id="statTotal">0</div>
                <div class="label">Total</div>
            </div>
        </div>
    </div>
  </aside>

  <main class="quiz-main">
    <div class="quiz-main-header">
      <button class="mobile-menu-toggle" id="openInfoSidebar"><i class="fas fa-bars"></i></button>
      <div class="progress flex-grow-1 mx-3" style="height: 10px;">
        <div id="quizProgress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <div id="progressText" class="fw-bold">0 / 0 Answered</div>
      <button class="mobile-menu-toggle" id="openPaletteSidebar"><i class="fas fa-th-large"></i></button>
    </div>
    <h2 class="text-center my-3 fw-bold"></h2>
    <div id="questionArea">
      </div>
    
    <div class="text-center my-4" id="submitBtnContainer">
        <button id="submitBtn" class="btn btn-danger py-2 px-5 fw-bold">
            <i class="fas fa-paper-plane me-2"></i>Submit Quiz
        </button>
    </div>

    <div id="resultsContainer" style="display: none;">
      </div>
  </main>

  <aside class="quiz-palette" id="paletteSidebar">
     <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold m-0">Question Palette</h5>
        <button class="mobile-menu-toggle" id="closePaletteSidebar"><i class="fas fa-times"></i></button>
    </div>
    <div class="palette-grid" id="qList"></div>
    <div class="mt-4">
        <h6 class="fw-bold">Legend</h6>
        <div class="d-flex align-items-center small my-2"><div class="q-tile me-2" style="width: 25px; height: 25px;"></div> Not Visited</div>
        <div class="d-flex align-items-center small my-2"><div class="q-tile answered me-2" style="width: 25px; height: 25px;"></div> Answered</div>
        <div class="d-flex align-items-center small my-2"><div class="q-tile marked me-2" style="width: 25px; height: 25px;"></div> Marked for Review</div>
        <div class="d-flex align-items-center small my-2"><div class="q-tile current me-2" style="width: 25px; height: 25px;"></div> Current Question</div>
    </div>
  </aside>

</div>

<button class="theme-toggle" id="themeToggle"><i class="fas fa-moon"></i></button>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const quizData = /* QUIZ_DATA_PLACEHOLDER */;

</script>
<script>
(function(){
  // ----- Config from quizData.settings -----
  const TOTAL_TIME = (quizData.settings && quizData.settings.totalTimeSec) || 20*60;
  const NEGATIVE = (quizData.settings && quizData.settings.negativeMarkPerWrong) || (1/3);

  // ----- State -----
  const state = {
    current: 0,
    answers: Array(quizData.questions.length).fill(null),
    markedForReview: Array(quizData.questions.length).fill(false),
    startTime: new Date(),
    timePerQ: Array(quizData.questions.length).fill(0),
    submitted: false,
    inReviewMode: false,
    darkMode: false,
    totalTime: TOTAL_TIME,
    negativeMark: NEGATIVE,
    avgTime: 0,
    timerInterval: null,
    lastSoundIdx: -1
  };

  // ----- Elements -----
  const questionArea = document.getElementById('questionArea');
  const resultsContainer = document.getElementById('resultsContainer');
  const submitBtn = document.getElementById('submitBtn');
  const qListGrid = document.getElementById('qList');
  const themeToggle = document.getElementById('themeToggle');
  const clickSound = document.getElementById('clickSound');
  const correctSound = document.getElementById('correctSound');
  const wrongSound = document.getElementById('wrongSound');

  // ----- Init -----
  document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('qa_theme') === 'dark') {
      document.body.classList.add('dark-mode');
    }
    initQuiz();
  });
  
  function initQuiz() {
    buildQuestionTiles();
    renderQuestion(0);
    initTimer();
    initNav();
    initTheme();
    updateStats();
  }
  
  function initNav(){
    submitBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to submit the quiz?')) {
            submitQuiz();
        }
    });

    // Mobile Sidebar Toggles
    const infoSidebar = document.getElementById('infoSidebar');
    const paletteSidebar = document.getElementById('paletteSidebar');
    const overlay = document.getElementById('overlay');
    const openInfo = document.getElementById('openInfoSidebar');
    const closeInfo = document.getElementById('closeInfoSidebar');
    const openPalette = document.getElementById('openPaletteSidebar');
    const closePalette = document.getElementById('closePaletteSidebar');

    const toggleSidebar = (sidebar, action) => {
        sidebar.classList[action]('show');
        overlay.classList[action]('show');
    };

    openInfo.addEventListener('click', () => toggleSidebar(infoSidebar, 'add'));
    closeInfo.addEventListener('click', () => toggleSidebar(infoSidebar, 'remove'));
    openPalette.addEventListener('click', () => toggleSidebar(paletteSidebar, 'add'));
    closePalette.addEventListener('click', () => toggleSidebar(paletteSidebar, 'remove'));
    overlay.addEventListener('click', () => {
        toggleSidebar(infoSidebar, 'remove');
        toggleSidebar(paletteSidebar, 'remove');
    });

    // keyboard
    document.addEventListener('keydown',(e)=>{
      if(e.target.tagName === 'INPUT') return;
      if(e.key==='ArrowLeft') go(-1);
      if(e.key==='ArrowRight') go(1);
    });
  }

  function initTheme(){
    const saved = localStorage.getItem('qa_theme');
    if(saved==='dark'){ document.body.classList.add('dark-mode'); state.darkMode=true; }
    updateThemeIcon();
    themeToggle.addEventListener('click', ()=>{
      state.darkMode = !state.darkMode;
      document.body.classList.toggle('dark-mode', state.darkMode);
      localStorage.setItem('qa_theme', state.darkMode?'dark':'light');
      updateThemeIcon();
      if(state.submitted) buildCharts(state.lastResultData);
    });
  }
  function updateThemeIcon(){
    const i = themeToggle.querySelector('i');
    i.classList.toggle('fa-moon', !state.darkMode);
    i.classList.toggle('fa-sun',  state.darkMode);
  }

  // ----- Timer -----
  function initTimer(){
    const start = Date.now();
    const duration = state.totalTime*1000;
    const end = start + duration;
    tick(); state.timerInterval = setInterval(tick, 1000);
    function tick(){
      const now = Date.now();
      const left = Math.max(0, end-now);
      const m = String(Math.floor(left/60000)).padStart(2,'0');
      const s = String(Math.floor((left%60000)/1000)).padStart(2,'0');
      document.getElementById('minutes').textContent = m;
      document.getElementById('seconds').textContent = s;
      const pct = (left/duration)*100;
      const bar = document.getElementById('timeProgress');
      bar.style.width = pct + '%';
      if(left<=0){ clearInterval(state.timerInterval); submitQuiz(); }
      else if(pct<25) bar.className='progress-bar bg-danger';
      else if(pct<50) bar.className='progress-bar bg-warning';
      else bar.className='progress-bar bg-primary';
    }
  }

  // ----- Sidebar tiles -----
  function buildQuestionTiles(){
    qListGrid.innerHTML = '';
    quizData.questions.forEach((_,i)=>{
      const d = document.createElement('div');
      d.className='q-tile'; d.textContent=i+1;
      d.addEventListener('click', ()=>{
        if(!state.submitted) updateTime();
        renderQuestion(i);
        document.getElementById('paletteSidebar').classList.remove('show');
        document.getElementById('overlay').classList.remove('show');
      });
      qListGrid.appendChild(d);
    });
  }
  
  function updateTiles(){
    document.querySelectorAll('.q-tile').forEach((el,idx)=>{
      el.className='q-tile'; // Reset
      if(state.submitted){
          if(state.answers[idx] === quizData.questions[idx].correctIndex) el.classList.add('review-correct');
          else if(state.answers[idx] !== null) el.classList.add('review-incorrect');
          else el.classList.add('review-unattempted');
      } else {
        if(state.answers[idx] !== null) el.classList.add('answered');
        if(state.markedForReview[idx]) el.classList.add('marked');
      }
      if(idx === state.current) el.classList.add('current');
    });
  }

  // ----- Render question -----
  function renderQuestion(idx){
    if (idx < 0 || idx >= quizData.questions.length) return;
    state.current=idx;
    const q=quizData.questions[idx];
    let html=`
      <div class="card-ui">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="fw-bold m-0">Question ${idx+1}</h5>
            ${q.reference ? `<div class="small opacity-75">${q.reference}</div>` : ''}
        </div>
        <div class="q-text">${q.text}</div>
        <div class="options">`;
    q.options.forEach((opt,i)=>{
      let cls='option-btn';
      if(state.answers[idx]===i) cls+=' selected';
      if(state.submitted){
        if(i===q.correctIndex) cls+=' correct';
        else if(state.answers[idx]===i) cls+=' incorrect';
      }
      html += `<button class="${cls}" data-i="${i}">${opt}</button>`;
    });
    html += `</div>
        ${state.submitted ? `<div class="explanation"><strong>Explanation:</strong> ${q.explanation||'Not available.'}</div>` : ''}
      </div>
      <div class="quiz-nav-buttons">
          <button id="prevBtn" class="btn btn-outline-secondary btn-nav"><i class="fas fa-chevron-left me-2"></i>Previous</button>
          <button id="markBtn" class="btn btn-outline-info btn-nav">
              ${state.markedForReview[idx] ? '<i class="fas fa-bookmark me-2"></i>Unmark' : '<i class="far fa-bookmark me-2"></i>Mark for Review'}
          </button>
          <button id="nextBtn" class="btn btn-primary btn-nav">Next<i class="fas fa-chevron-right ms-2"></i></button>
      </div>
    `;
    questionArea.innerHTML=html;

    // Add event listeners to new elements
    document.getElementById('prevBtn').addEventListener('click', () => go(-1));
    document.getElementById('nextBtn').addEventListener('click', () => go(1));
    document.getElementById('markBtn').addEventListener('click', toggleMark);

    if(state.submitted) {
        document.getElementById('markBtn').style.display = 'none';
    }

    document.querySelectorAll('.option-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        if(state.submitted) return;
        clickSound.currentTime=0; clickSound.play();
        const i = parseInt(btn.dataset.i);
        state.answers[state.current] = (state.answers[state.current] === i) ? null : i; // Allow un-selecting
        renderQuestion(state.current); // Re-render to show selection change
        updateStats();
        updateTiles();
      });
    });

    updateTiles();
    updateProgress();

    // Sound for review mode
    if(state.inReviewMode && state.lastSoundIdx!==idx){
      state.lastSoundIdx=idx;
      const isAttempted = state.answers[idx]!==null;
      const isCorrect = isAttempted && state.answers[idx]===q.correctIndex;
      if(isAttempted){
        setTimeout(()=>{ (isCorrect?correctSound:wrongSound).play(); }, 250);
      }
    }
  }

  function go(dir){
    const i = state.current + dir;
    if(i>=0 && i<quizData.questions.length){
      if(!state.submitted) updateTime();
      renderQuestion(i);
    }
  }

  function toggleMark() {
    state.markedForReview[state.current] = !state.markedForReview[state.current];
    renderQuestion(state.current); // Re-render to update button text
    updateTiles();
    updateStats();
  }

  function updateTime(){
    const now = new Date();
    state.timePerQ[state.current] += (now - state.startTime)/1000;
    state.startTime = now;
  }

  function updateStats() {
    const answeredCount = state.answers.filter(a => a !== null).length;
    const markedCount = state.markedForReview.filter(m => m).length;
    const totalCount = quizData.questions.length;
    document.getElementById('statAnswered').textContent = answeredCount;
    document.getElementById('statUnanswered').textContent = totalCount - answeredCount;
    document.getElementById('statMarked').textContent = markedCount;
    document.getElementById('statTotal').textContent = totalCount;
  }
  
  function updateProgress() {
      const answeredCount = state.answers.filter(a => a !== null).length;
      const totalCount = quizData.questions.length;
      const percent = (answeredCount / totalCount) * 100;
      document.getElementById('quizProgress').style.width = `${percent}%`;
      document.getElementById('progressText').textContent = `${answeredCount} / ${totalCount} Answered`;
  }

  // ----- Submit & Results -----
  function submitQuiz(){
    if(state.submitted) return;
    clearInterval(state.timerInterval);
    updateTime();
    state.submitted=true;

    let correct=0, incorrect=0, unattempted=0, score=0, neg=0;
    state.answers.forEach((a,i)=>{
      if(a===null){ unattempted++; }
      else if(a===quizData.questions[i].correctIndex){ correct++; score+=1; }
      else { incorrect++; score-=state.negativeMark; neg+=state.negativeMark; }
    });

    state.avgTime = state.timePerQ.reduce((s,t)=>s+t,0)/quizData.questions.length;
    const pct = (score/quizData.questions.length)*100;
    
    questionArea.style.display = 'none';
    document.getElementById('submitBtnContainer').style.display = 'none';
    document.querySelector('.quiz-main-header').style.display = 'none';
    
    renderResults({correct, incorrect, unattempted, score, neg, pct});
    resultsContainer.style.display = 'block';

    updateTiles();
    
    if(pct>=70){ confetti(); correctSound.play(); }
    else if(pct<50){ wrongSound.play(); }
  }

  function renderResults(resData) {
      const { correct, incorrect, unattempted, score, neg, pct } = resData;
      const total = quizData.questions.length;
      state.lastResultData = resData; // Save for redrawing charts on theme change

      let html = `
        <div class="results-container card-ui text-start">
            <div class="text-center">
                <h2 class="fw-bold">Quiz Completed!</h2>
                <p>Here is your performance summary.</p>
                <div class="final-score">${pct.toFixed(1)}%</div>
                <div class="fs-4 fw-bold mb-4">${score.toFixed(2)} / ${total}</div>
            </div>
            
            <ul class="nav nav-pills justify-content-center mb-3 results-tabs" id="pills-tab" role="tablist">
              <li class="nav-item" role="presentation"><button class="nav-link active" id="pills-summary-tab" data-bs-toggle="pill" data-bs-target="#pills-summary" type="button" role="tab">Summary</button></li>
              <li class="nav-item" role="presentation"><button class="nav-link" id="pills-analysis-tab" data-bs-toggle="pill" data-bs-target="#pills-analysis" type="button" role="tab">Analysis</button></li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
              <div class="tab-pane fade show active" id="pills-summary" role="tabpanel">
                <div class="row g-3">
                    <div class="col-md-6"><div class="p-3 bg-light rounded d-flex justify-content-between"><span>Total Questions</span><span class="fw-bold">${total}</span></div></div>
                    <div class="col-md-6"><div class="p-3 bg-light rounded d-flex justify-content-between"><span>Correct</span><span class="fw-bold text-success">${correct}</span></div></div>
                    <div class="col-md-6"><div class="p-3 bg-light rounded d-flex justify-content-between"><span>Incorrect</span><span class="fw-bold text-danger">${incorrect}</span></div></div>
                    <div class="col-md-6"><div class="p-3 bg-light rounded d-flex justify-content-between"><span>Unattempted</span><span class="fw-bold text-warning">${unattempted}</span></div></div>
                    <div class="col-md-6"><div class="p-3 bg-light rounded d-flex justify-content-between"><span>Negative Marks</span><span class="fw-bold text-danger">-${neg.toFixed(2)}</span></div></div>
                </div>
              </div>
              <div class="tab-pane fade" id="pills-analysis" role="tabpanel">
                <div class="chart-container mb-3"><canvas id="performanceChart"></canvas></div>
                <div class="chart-container" style="height: 300px;"><canvas id="timeAnalysisChart"></canvas></div>
              </div>
            </div>
            <div class="text-center mt-4">
                <button id="reviewBtn" class="btn btn-primary btn-lg"><i class="fas fa-search me-2"></i>Review Answers</button>
            </div>
        </div>
      `;
      resultsContainer.innerHTML = html;

      document.getElementById('reviewBtn').addEventListener('click', reviewMode);

      // Trigger chart build after tab is shown
      const analysisTab = document.getElementById('pills-analysis-tab');
      analysisTab.addEventListener('shown.bs.tab', () => buildCharts(resData), { once: true });
  }

  let performanceChartInstance, timeAnalysisChartInstance;
  function buildCharts(res){
    const {correct, incorrect, unattempted} = res;
    Chart.defaults.color = state.darkMode ? '#e8eaed' : '#6c757d';
    
    if (performanceChartInstance) performanceChartInstance.destroy();
    performanceChartInstance = new Chart(document.getElementById('performanceChart').getContext('2d'),{
      type:'doughnut',
      data:{ labels:['Correct','Incorrect','Unattempted'],
        datasets:[{ data:[correct,incorrect,unattempted],
          backgroundColor:['#20c997','#e63946','#ffb703'], borderWidth: 0 }]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
    });

    const labels = Array.from({length:quizData.questions.length},(_,i)=>`Q${i+1}`);
    const correctTimes = state.timePerQ.map((t,i) => state.answers[i] === quizData.questions[i].correctIndex ? t : 0);
    const incorrectTimes = state.timePerQ.map((t,i) => (state.answers[i] !== null && state.answers[i] !== quizData.questions[i].correctIndex) ? t : 0);

    if(timeAnalysisChartInstance) timeAnalysisChartInstance.destroy();
    timeAnalysisChartInstance = new Chart(document.getElementById('timeAnalysisChart').getContext('2d'),{
      type:'bar',
      data:{ labels,
        datasets:[
          {label:'Correct', data:correctTimes, backgroundColor:'rgba(32, 201, 151, 0.7)'},
          {label:'Incorrect', data:incorrectTimes, backgroundColor:'rgba(230, 57, 70, 0.7)'}
        ]},
      options:{ responsive:true, maintainAspectRatio:false, indexAxis: 'x',
        scales:{ x:{stacked:true, grid: {color: state.darkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}},
                 y:{stacked:true, title:{display:true,text:'Time (s)'}, grid: {color: state.darkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}} },
      }
    });
  }

  function reviewMode(){
    state.inReviewMode=true; state.lastSoundIdx=-1;
    questionArea.style.display='block';
    resultsContainer.style.display='none';
    document.querySelector('.quiz-main-header').style.display = 'flex';
    renderQuestion(0);
  }

  function confetti(){
    const colors=['#6a5af9','#f72585','#20c997','#ffb703'];
    for(let i=0;i<100;i++){
      const d=document.createElement('div');
      d.style.cssText=`position:fixed;width:10px;height:10px;top:-10px;left:${Math.random()*100}vw;background:${colors[Math.floor(Math.random()*colors.length)]};z-index:1300;`;
      document.body.appendChild(d);
      const dy = Math.random()*500+500, rot = Math.random()*360;
      const anim = d.animate([{transform:'translateY(0) rotate(0)',opacity:1},{transform:`translateY(${dy}px) rotate(${rot}deg)`,opacity:0}],
        {duration:Math.random()*2000+2000, easing:'ease-out'});
      anim.onfinish=()=>d.remove();
    }
  }
})();
</script>
</body>
</html>
